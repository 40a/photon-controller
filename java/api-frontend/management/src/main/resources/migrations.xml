<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet id="1" author="esxcloud">
    <createTable tableName="tag">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="value" type="varchar(255)"/>
    </createTable>

    <createIndex indexName="idx_tag_value"
                 tableName="tag">
      <column name="value" type="varchar(255)"/>
    </createIndex>

    <!-- tombstone -->
    <createTable tableName="tombstone">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="tombstone_time" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="entity_kind" type="varchar(20)">
        <constraints nullable="false"/>
      </column>
      <column name="entity_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_tombstone_tombstone_time"
                 tableName="tombstone">
      <column name="tombstone_time" type="bigint"/>
    </createIndex>

    <createIndex indexName="idx_tombstone_entity_kind"
                 tableName="tombstone">
      <column name="entity_kind" type="varchar(20)"/>
    </createIndex>

    <createIndex indexName="idx_tombstone_entity_id"
                 tableName="tombstone">
      <column name="entity_id" type="varchar(36)"/>
    </createIndex>

    <addUniqueConstraint tableName="tombstone" columnNames="entity_id" constraintName="uk_tombstone_entity_id"/>

    <!-- tasks begin -->
    <createTable tableName="task">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="project_id" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="state" type="varchar(255)"/>
      <column name="started_time" type="timestamp"/>
      <column name="queued_time" type="timestamp"/>
      <column name="end_time" type="timestamp"/>
      <column name="resource_properties" type="varchar(10240)">
        <constraints nullable="true"/>
      </column>
      <column name="entity_kind" type="varchar(20)"/>
      <column name="entity_id" type="varchar(36)"/>
      <column name="operation" type="varchar(255)"/>
    </createTable>

    <createIndex indexName="idx_task_state"
                 tableName="task">
      <column name="state" type="varchar(255)"/>
    </createIndex>

    <createIndex indexName="idx_task_entity_id_entity_kind"
                 tableName="task">
      <column name="entity_id" type="varchar(36)"/>
      <column name="entity_kind" type="varchar(20)"/>
    </createIndex>

    <createIndex indexName="idx_task_entity_id_entity_kind_state"
                 tableName="task">
      <column name="entity_id" type="varchar(36)"/>
      <column name="entity_kind" type="varchar(20)"/>
      <column name="state" type="varchar(255)"/>
    </createIndex>

    <createIndex indexName="idx_task_project_id"
                 tableName="task">
      <column name="project_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_task_project_id_entity_kind"
                 tableName="task">
      <column name="project_id" type="varchar(36)"/>
      <column name="entity_kind" type="varchar(20)"/>
    </createIndex>

    <createIndex indexName="idx_task_project_id_state"
                 tableName="task">
      <column name="project_id" type="varchar(36)"/>
      <column name="state" type="varchar(255)"/>
    </createIndex>

    <createIndex indexName="idx_task_project_id_entity_kind_state"
                 tableName="task">
      <column name="project_id" type="varchar(36)"/>
      <column name="entity_kind" type="varchar(20)"/>
      <column name="state" type="varchar(255)"/>
    </createIndex>

    <!-- tasks end -->

    <!-- steps begin -->
    <createTable tableName="step">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="task" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="sequence" type="integer"/>
      <column name="state" type="varchar(255)"/>
      <column name="started_time" type="timestamp"/>
      <column name="queued_time" type="timestamp"/>
      <column name="end_time" type="timestamp"/>
      <column name="operation" type="varchar(255)"/>
      <column name="options" type="varchar(8000)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createIndex indexName="idx_step_task"
                 tableName="step">
      <column name="task" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_step_state"
                 tableName="step">
      <column name="state" type="varchar(255)"/>
    </createIndex>

    <createIndex indexName="idx_step_state_task"
                 tableName="step">
      <column name="state" type="varchar(255)"/>
      <column name="task" type="varchar(36)"/>
    </createIndex>
    <!-- Note, this causes a forward reference, table not found error in script,
         so I moved this to after project table is defined

    <addForeignKeyConstraint baseTableName="step" baseColumnNames="task"
                             referencedTableName="task" referencedColumnNames="id"
                             constraintName="fk_step_task"/>
    -->

    <createTable tableName="step_error">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="step" type="varchar(36)">
        <constraints nullable="false"/>
      </column>

      <column name="code" type="varchar(36)"/>
      <column name="message" type="varchar(500)"/>
    </createTable>

    <createIndex indexName="idx_step_error_step"
                 tableName="step_error">
      <column name="step" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="step_error" baseColumnNames="step"
                             constraintName="fk_step_error" referencedTableName="step" referencedColumnNames="id"/>

    <createTable tableName="step_error_entity_data">
      <column name="step_error_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>

      <column name="data_key" type="varchar(255)"/>
      <column name="data" type="varchar(500)"/>
    </createTable>

    <addForeignKeyConstraint baseTableName="step_error_entity_data" baseColumnNames="step_error_entity"
                             constraintName="fk_step_error_entity" referencedTableName="step_error"
                             referencedColumnNames="id"/>

    <createTable tableName="step_warning">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="step" type="varchar(36)">
        <constraints nullable="false"/>
      </column>

      <column name="code" type="varchar(36)"/>
      <column name="message" type="varchar(500)"/>
    </createTable>

    <createIndex indexName="idx_step_warning_step"
                 tableName="step_warning">
      <column name="step" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="step_warning" baseColumnNames="step"
                             constraintName="fk_warning_error" referencedTableName="step" referencedColumnNames="id"/>

    <createTable tableName="step_warning_entity_data">
      <column name="step_warning_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>

      <column name="data_key" type="varchar(255)"/>
      <column name="data" type="varchar(500)"/>
    </createTable>

    <addForeignKeyConstraint baseTableName="step_warning_entity_data" baseColumnNames="step_warning_entity"
                             constraintName="fk_step_warning_entity" referencedTableName="step_warning"
                             referencedColumnNames="id"/>

    <createTable tableName="step_resource">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="step" type="varchar(36)">
        <constraints nullable="false"/>
      </column>

      <column name="entity_kind" type="varchar(20)"/>
      <column name="entity_id" type="varchar(36)"/>
    </createTable>

    <createIndex indexName="idx_step_resource_step"
                 tableName="step_resource">
      <column name="step" type="varchar(36)"/>
    </createIndex>


    <addForeignKeyConstraint baseTableName="step_resource" baseColumnNames="step"
                             constraintName="fk_step_resource" referencedTableName="step" referencedColumnNames="id"/>

    <!-- steps end -->

    <createTable tableName="tenant">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
    </createTable>

    <addUniqueConstraint tableName="tenant" columnNames="name" constraintName="uk_tenant_name"/>

    <createTable tableName="tenant_tags">
      <column name="tenant" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="tenant_tags" columnNames="tenant, tags"/>

    <addForeignKeyConstraint baseTableName="tenant_tags" baseColumnNames="tenant"
                             referencedTableName="tenant" referencedColumnNames="id"
                             constraintName="fk_tenant_tags_tenant"/>
    <addForeignKeyConstraint baseTableName="tenant_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_tenant_tags_tag"/>

    <createTable tableName="tenant_entity_security_groups">
      <column name="tenant_entity" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="inherited" type="boolean"/>
    </createTable>

    <createTable tableName="resource_ticket">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="tenant_id" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
      <column name="parent_id" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <addUniqueConstraint tableName="resource_ticket" columnNames="tenant_id, name"
                         constraintName="uk_resource_ticket_tenant_name"/>

    <addForeignKeyConstraint baseTableName="resource_ticket" baseColumnNames="parent_id"
                             referencedTableName="resource_ticket" referencedColumnNames="id"
                             constraintName="fk_resource_ticket_parent"/>

    <createTable tableName="resource_ticket_tags">
      <column name="resource_ticket" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="resource_ticket_tags" columnNames="resource_ticket, tags"/>

    <addForeignKeyConstraint baseTableName="resource_ticket_tags" baseColumnNames="resource_ticket"
                             referencedTableName="resource_ticket" referencedColumnNames="id"
                             constraintName="fk_resource_ticket_tags_resource_ticket"/>
    <addForeignKeyConstraint baseTableName="resource_ticket_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_resource_ticket_tags_tag"/>

    <createTable tableName="resource_ticket_entity_limit_map">
      <column name="limit_map_key" type="varchar(64)"/>
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="resource_ticket_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_resource_ticket_entity_limit_map_resource_ticket_entity"
                 tableName="resource_ticket_entity_limit_map">
      <column name="resource_ticket_entity" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="resource_ticket_entity_limit_map" baseColumnNames="resource_ticket_entity"
                             referencedTableName="resource_ticket" referencedColumnNames="id"
                             constraintName="fk_resource_ticket_limit_map"/>

    <createTable tableName="resource_ticket_entity_usage_map">
      <column name="usage_map_key" type="varchar(64)"/>
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="resource_ticket_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_resource_ticket_entity_usage_map_resource_ticket_entity"
                 tableName="resource_ticket_entity_usage_map">
      <column name="resource_ticket_entity" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="resource_ticket_entity_usage_map" baseColumnNames="resource_ticket_entity"
                             referencedTableName="resource_ticket" referencedColumnNames="id"
                             constraintName="fk_resource_ticket_usage_map"/>


    <createTable tableName="project">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="tenant_id" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="resource_ticket" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint tableName="project" columnNames="tenant_id, name" constraintName="uk_project_tenant_name"/>

    <addForeignKeyConstraint baseTableName="project" baseColumnNames="resource_ticket"
                             referencedTableName="resource_ticket" referencedColumnNames="id"
                             constraintName="fk_project_resource_ticket"/>

    <createTable tableName="project_tags">
      <column name="project" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="project_tags" columnNames="project, tags"/>

    <addForeignKeyConstraint baseTableName="project_tags" baseColumnNames="project"
                             referencedTableName="project" referencedColumnNames="id"
                             constraintName="fk_project_tags_project"/>
    <addForeignKeyConstraint baseTableName="project_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_project_tags_tag"/>

    <createTable tableName="project_entity_security_groups">
      <column name="project_entity" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="inherited" type="boolean"/>
    </createTable>

    <!-- flavor table, cost, and tags -->
    <createTable tableName="flavor">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="kind" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="state" type="varchar(36)"/>
    </createTable>

    <addUniqueConstraint tableName="flavor" columnNames="name, kind"
                         constraintName="uk_flavor_name_kind"/>

    <createTable tableName="flavor_tags">
      <column name="flavor" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="flavor_tags" columnNames="flavor, tags"/>

    <addForeignKeyConstraint baseTableName="flavor_tags" baseColumnNames="flavor"
                             referencedTableName="flavor" referencedColumnNames="id"
                             constraintName="fk_flavor_tags_project"/>
    <addForeignKeyConstraint baseTableName="flavor_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_flavor_tags_tag"/>

    <createTable tableName="flavor_entity_cost">
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="flavor_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_flavor_entity_cost_flavor_entity"
                 tableName="flavor_entity_cost">
      <column name="flavor_entity" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="flavor_entity_cost" baseColumnNames="flavor_entity"
                             referencedTableName="flavor" referencedColumnNames="id"
                             constraintName="fk_flavor_entity_cost"/>

    <!-- vm, it's cost, and it's tags -->
    <createTable tableName="vm">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="project_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="flavor_id" type="varchar(36)"/>
      <column name="image_id" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="default_gateway" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
      <column name="agent" type="varchar(36)"/>
      <column name="state" type="varchar(36)"/>
      <column name="datastore" type="varchar(36)"/>
      <column name="datastore_name" type="varchar(36)"/>
      <column name="host" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createIndex indexName="idx_vm_image"
                 tableName="vm">
      <column name="image_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_vm_flavor_id"
                 tableName="vm">
      <column name="flavor_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_vm_host"
                 tableName="vm">
      <column name="host" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_vm_project_id"
                 tableName="vm">
      <column name="project_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_vm_name_project_id"
                 tableName="vm">
      <column name="name" type="varchar(255)"/>
      <column name="project_id" type="varchar(36)"/>
    </createIndex>

    <createTable tableName="vm_entity_cost">
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="vm_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_vm_entity_cost_vm_entity"
                 tableName="vm_entity_cost">
      <column name="vm_entity" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="vm_entity_cost" baseColumnNames="vm_entity"
                             referencedTableName="vm" referencedColumnNames="id"
                             constraintName="fk_vm_cost"/>

    <createTable tableName="vm_tags">
      <column name="vm" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="vm_tags" columnNames="vm, tags"/>

    <addForeignKeyConstraint baseTableName="vm_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_vm_tags_tag"/>
    <addForeignKeyConstraint baseTableName="vm_tags" baseColumnNames="vm"
                             referencedTableName="vm" referencedColumnNames="id"
                             constraintName="fk_vm_tags_vm"/>

    <createTable tableName="vm_entity_metadata">
      <column name="vm_entity" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="metadata_key" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="metadata" type="VARCHAR(2048)"/>
    </createTable>
    <addPrimaryKey columnNames="vm_entity, metadata_key"
                   constraintName="vm_entity_metadata_pkey" tableName="vm_entity_metadata"/>

    <addForeignKeyConstraint baseColumnNames="vm_entity" baseTableName="vm_entity_metadata"
                             constraintName="fk_vm_entity_metadata" deferrable="false" initiallyDeferred="false"
                             onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                             referencedTableName="vm"/>

    <createTable tableName="vm_entity_networks">
      <column name="vm_entity" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="networks" type="varchar(255)"/>
    </createTable>

    <createTable tableName="persistent_disk">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="project_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="flavor_id" type="varchar(36)"/>
      <column name="capacity_gb" type="integer"/>
      <column name="agent" type="varchar(36)"/>
      <column name="datastore" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="state" type="varchar(36)"/>
    </createTable>

    <createTable tableName="persistent_disk_entity_cost">
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="persistent_disk_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="persistent_disk_entity_cost" baseColumnNames="persistent_disk_entity"
                             referencedTableName="persistent_disk" referencedColumnNames="id"
                             constraintName="fk_persistent_disk_cost"/>

    <createTable tableName="persistent_disk_tags">
      <column name="persistent_disk" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="persistent_disk_tags" columnNames="persistent_disk, tags"/>

    <addForeignKeyConstraint baseTableName="persistent_disk_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_persistent_disk_tags_tag"/>
    <addForeignKeyConstraint baseTableName="persistent_disk_tags" baseColumnNames="persistent_disk"
                             referencedTableName="persistent_disk" referencedColumnNames="id"
                             constraintName="fk_persistent_disk_tags_persistent_disk"/>

    <createTable tableName="ephemeral_disk">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)"/>
      <column name="project_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="flavor_id" type="varchar(255)"/>
      <column name="capacity_gb" type="integer"/>
      <column name="datastore" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="state" type="varchar(36)"/>
    </createTable>

    <createTable tableName="ephemeral_disk_entity_cost">
      <column name="key" type="varchar(64)"/>
      <column name="value" type="double"/>
      <column name="unit" type="integer"/>
      <column name="ephemeral_disk_entity" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_ephemeral_disk_entity_cost_ephemeral_disk_entity"
                 tableName="ephemeral_disk_entity_cost">
      <column name="ephemeral_disk_entity" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="ephemeral_disk_entity_cost" baseColumnNames="ephemeral_disk_entity"
                             referencedTableName="ephemeral_disk" referencedColumnNames="id"
                             constraintName="fk_ephemeral_disk_cost"/>

    <createTable tableName="ephemeral_disk_tags">
      <column name="ephemeral_disk" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="tags" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="ephemeral_disk_tags" columnNames="ephemeral_disk, tags"/>

    <addForeignKeyConstraint baseTableName="ephemeral_disk_tags" baseColumnNames="tags"
                             referencedTableName="tag" referencedColumnNames="id"
                             constraintName="fk_ephemeral_disk_tags_tag"/>
    <addForeignKeyConstraint baseTableName="ephemeral_disk_tags" baseColumnNames="ephemeral_disk"
                             referencedTableName="ephemeral_disk" referencedColumnNames="id"
                             constraintName="fk_ephemeral_disk_tags_ephemeral_disk"/>

    <createTable tableName="attached_disk">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="kind" type="varchar(20)"/>
      <column name="boot_disk" type="boolean"/>
      <column name="persistent_disk_id" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="ephemeral_disk_id" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="vm_id" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createIndex indexName="idx_attached_disk_vm_id"
                 tableName="attached_disk">
      <column name="vm_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_attached_disk_ephemeral_disk_id"
                 tableName="attached_disk">
      <column name="ephemeral_disk_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_attached_disk_persistent_disk_id"
                 tableName="attached_disk">
      <column name="persistent_disk_id" type="varchar(36)"/>
    </createIndex>

    <addUniqueConstraint tableName="attached_disk" columnNames="persistent_disk_id"
                         constraintName="uk_attached_disk_persistent_disk"/>

    <addUniqueConstraint tableName="attached_disk" columnNames="ephemeral_disk_id"
                         constraintName="uk_attached_disk_ephemeral_disk"/>

    <createTable tableName="locality">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="resource_id" type="varchar(36)">
      </column>
      <column name="kind" type="varchar(20)"/>
    </createTable>

    <createIndex indexName="idx_locality_resource_id"
                 tableName="locality">
      <column name="resource_id" type="varchar(36)"/>
    </createIndex>

    <createTable tableName="locality_vm">
      <column name="vm" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="locality" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_locality_vm_locality"
                 tableName="locality_vm">
      <column name="locality" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="locality_vm" baseColumnNames="vm"
                             referencedTableName="vm" referencedColumnNames="id"
                             constraintName="fk_locality_vm_vm_constraint"/>

    <addForeignKeyConstraint baseTableName="locality_vm" baseColumnNames="locality"
                             referencedTableName="locality" referencedColumnNames="id"
                             constraintName="fk_locality_vm_locality_constraint"/>

    <createTable tableName="locality_disk">
      <column name="disk" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
      <column name="locality" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_locality_disk_locality"
                 tableName="locality_disk">
      <column name="locality" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="locality_disk" baseColumnNames="disk"
                             referencedTableName="persistent_disk" referencedColumnNames="id"
                             constraintName="fk_locality_disk_disk_constraint"/>

    <addForeignKeyConstraint baseTableName="locality_disk" baseColumnNames="locality"
                             referencedTableName="locality" referencedColumnNames="id"
                             constraintName="fk_locality_disk_locality_constraint"/>

    <createTable tableName="step_lock">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="entity_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="step_id" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex indexName="idx_step_lock_step_id"
                 tableName="step_lock">
      <column name="step_id" type="varchar(36)"/>
    </createIndex>

    <createIndex indexName="idx_step_lock_entity_id"
                 tableName="step_lock">
      <column name="entity_id" type="varchar(36)"/>
    </createIndex>

    <createTable tableName="resource_reservation">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="reservation" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createTable tableName="network">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
      <column name="port_groups" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="state" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="network_connection">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="network" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="ip_address" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="netmask" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="image">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="size" type="bigint">
        <constraints nullable="true"/>
      </column>
      <column name="state" type="varchar(36)"/>
      <column name="replication_type" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="total_image_datastore" type="int">
        <constraints nullable="true"/>
      </column>
      <column name="total_datastore" type="int">
        <constraints nullable="true"/>
      </column>
      <column name="replicated_datastore" type="int">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createTable tableName="image_settings">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="image" type="varchar(36)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="default_value" type="varchar(255)"/>
    </createTable>

    <addForeignKeyConstraint baseTableName="image_settings" baseColumnNames="image"
                             referencedTableName="image" referencedColumnNames="id"
                             constraintName="fk_image_settings"/>

    <createTable tableName="iso">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="true"/>
      </column>
      <column name="size" type="bigint">
        <constraints nullable="true"/>
      </column>
      <column name="vm" type="varchar(36)">
        <constraints nullable="true"/>
      </column>
    </createTable>

    <createIndex indexName="idx_iso_vm"
                 tableName="iso">
      <column name="vm" type="varchar(36)"/>
    </createIndex>

    <addForeignKeyConstraint baseTableName="iso" baseColumnNames="vm"
                             referencedTableName="vm" referencedColumnNames="id"
                             constraintName="fk_iso_vm"/>

    <createTable tableName="port_group">
      <column name="id" type="VARCHAR(255)">
        <constraints nullable="false" primaryKey="true" primaryKeyName="port_group_pkey"/>
      </column>
      <column name="port_group_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="start_address" type="VARCHAR(255)"/>
      <column name="end_address" type="VARCHAR(255)"/>
      <column name="subnet_mask" type="VARCHAR(255)"/>
      <column name="gateway" type="VARCHAR(255)"/>
      <column name="usage_tags" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="datastore">
      <column name="id" type="VARCHAR(255)">
        <constraints nullable="false" primaryKey="true" primaryKeyName="datastore_pkey"/>
      </column>
      <column name="name" type="VARCHAR(255)"/>
      <column name="esx_id" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="host_ips" type="VARCHAR(255)"/>
      <column name="tags" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="datastore_entity_metadata">
      <column name="datastore_entity" type="VARCHAR(255)">
        <constraints nullable="false" primaryKey="true" primaryKeyName="datastore_entity_metadata_pkey"/>
      </column>
      <column name="metadata" type="VARCHAR(255)"/>
      <column name="metadata_key" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseColumnNames="datastore_entity" baseTableName="datastore_entity_metadata"
                             constraintName="fk_datastore_entity" deferrable="false" initiallyDeferred="false"
                             onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                             referencedTableName="datastore"/>

    <createTable tableName="host">
      <column name="id" type="VARCHAR(255)">
        <constraints nullable="false" primaryKey="true" primaryKeyName="host_pkey"/>
      </column>
      <column name="state" type="varchar(36)"/>
      <column name="address" type="VARCHAR(255)"/>
      <column name="password" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="esx_version" type="VARCHAR(255)"/>
      <column name="usage_tags" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="username" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="availability_zone" type="VARCHAR(255)"/>
    </createTable>

    <createTable tableName="host_entity_metadata">
      <column name="host_entity" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="metadata_key" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="metadata" type="VARCHAR(255)"/>
    </createTable>
    <addPrimaryKey columnNames="host_entity, metadata_key"
                   constraintName="host_entity_metadata_pkey" tableName="host_entity_metadata"/>

    <addForeignKeyConstraint baseColumnNames="host_entity" baseTableName="host_entity_metadata"
                             constraintName="fk_host_entity_metadata" deferrable="false" initiallyDeferred="false"
                             onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                             referencedTableName="host"/>

    <createTable tableName="deployment">
      <column name="id" type="varchar(255)">
        <constraints nullable="false" primaryKey="true" primaryKeyName="deployment_pkey"/>
      </column>
      <column name="state" type="varchar(36)"/>
      <column name="syslog_endpoint" type="varchar(255)"/>
      <column name="auth_enabled" type="boolean">
        <constraints nullable="false"/>
      </column>
      <column name="oauth_endpoint" type="varchar(255)"/>
      <column name="oauth_port" type="int"/>
      <column name="oauth_tenant" type="varchar(255)"/>
      <column name="oauth_username" type="varchar(255)"/>
      <column name="oauth_password" type="varchar(255)"/>
      <column name="oauth_security_groups" type="varchar(255)"/>
      <column name="ntp_endpoint" type="varchar(255)"/>
      <column name="image_datastore" type="varchar(255)"/>
      <column name="use_image_datastore_for_vms" type="boolean">
        <constraints nullable="false"/>
      </column>
      <column name="load_balancer_enabled" type="boolean"/>
      <column name="vibs_uploaded" type="long"/>
      <column name="vibs_uploading" type="long"/>
    </createTable>

    <createTable tableName="deployment_entity_migration_progress">
      <column name="deployment_entity" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="migration_progress_key" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="migration_progress" type="int"/>
    </createTable>

    <createTable tableName="deployment_entity_oauth_security_groups">
      <column name="deployment_entity" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="oauth_security_groups" type="varchar(255)"/>
    </createTable>

    <createTable tableName="availability_zone">
      <column name="id" type="varchar(36)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="state" type="varchar(36)"/>
    </createTable>

  </changeSet>

</databaseChangeLog>
